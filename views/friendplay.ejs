<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- ejs magic -->
    <%- include('./partials/head'); %>
 </head>
    <body>
        <%- include('./partials/navbar'); %>
        <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
        <script>
            var peer = new Peer();
 
            peer.on('open', function(id) 
            {
                document.getElementById("demo").innerHTML = id;
            }); 
 
            peer.on('connection', function(connection)
            {
                setInterval(score_dispatch, 1000, connection);
 
                connection.on('data', function(data)
                {
                    console.log(data);
                    document.getElementById("demo").innerHTML = data;
                });
            });
 
            peer.on('call', function(call) 
            {
                navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then( 
                function(stream)
                {
                    call.answer(stream);
 
                    call.on('stream', function(stream)
                    {
                        video = document.getElementById('sendvidshere');
                        video.srcObject = stream;
                        video.autoplay= true;
                    });
                }).catch(() => {});
            });
 
            function score_dispatch(conn)
            {
                conn.send(Math.random() * 1000000);
            }
            
            function do_call()
            {
                connection = peer.connect(document.getElementById("id-supply").value);
                connection.on('data', function(data)
                {
                    console.log(data);
                    document.getElementById("demo").innerHTML = data;
                });
                setInterval(score_dispatch, 1000, connection);
                navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then( 
                function(stream)
                {
                    console.log(document.getElementById("id-supply").value);
                    call = peer.call(document.getElementById("id-supply").value, stream);
 
                    call.on('stream', function(stream)
                    {
                        video = document.getElementById('sendvidshere');
                        video.srcObject = stream;
                        video.autoplay= true;
                    });
                }).catch(() => {});
            };
        </script>
    
        <form>
            <textarea id="id-supply"></textarea>
            <button type="button" onclick="do_call()">submit</button>
        </form>
 
        <p>Generated Peer ID is: </p>
        <p id="demo"></p>
        <video id="sendvidshere"></video>
    </body>  