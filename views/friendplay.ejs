<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="icon" href="favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- ejs magic -->
    <%- include('./partials/head'); %>
</head>

<body>
    <%- include('./partials/navbar'); %>

        <form>
            <textarea id="id-supply"></textarea>
            <button type="button" onclick="do_call()">submit</button>
        </form>

        <p>Generated Peer ID is: </p>
        <p id="demo"></p>
        <video id="sendvidshere"></video>

        <div class="ui middle center aligned three column grid">
            <div class="one wide column">
                <button class="ui circular huge icon button black" id="mutebutton" onclick="mutebutton()">
                    <i class="microphone icon"></i>
                </button>
            </div>
            <div class="two wide column">
                <button class="ui labeled red large icon button" onclick="endcall()">
                    <i class="stop icon"></i>
                    End call
                </button>
            </div>
            <div class="one wide column">
                <button class="ui circular huge icon button black" id="vidbutton" onclick="vidbutton()">
                    <i class="video icon"></i>
                </button>
            </div>

        </div>



        <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
        <script>

            let muted=true;
            let vidon=true;

            function mutebutton(){
                muted = !muted;
                document.getElementById("mutebutton").className = "ui circular huge icon button"+(muted?" black":"");
                //do webrtc mute here 






            }

            function vidbutton(){
                vidon = !vidon;
                document.getElementById("vidbutton").className = "ui circular huge icon button"+(vidon?" black":"");
                //do webrtc vid on/vid off here 







            }

            function endcall(){
                //end the vid chat stuff here





                
            }




            //webrtc stuff
            var peer = new Peer();

            peer.on('open', function (id) {
                document.getElementById("demo").innerHTML = id;
            });

            peer.on('connection', function (connection) {
                setInterval(score_dispatch, 1000, connection);

                connection.on('data', function (data) {
                    console.log(data);
                    document.getElementById("demo").innerHTML = data;
                });
            });

            peer.on('call', function (call) {
                navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(
                    function (stream) {
                        call.answer(stream);

                        call.on('stream', function (stream) {
                            video = document.getElementById('sendvidshere');
                            video.srcObject = stream;
                            video.autoplay = true;
                        });
                    }).catch(() => { });
            });

            function score_dispatch(conn) {
                conn.send(Math.random() * 1000000);
            }

            function do_call() {
                connection = peer.connect(document.getElementById("id-supply").value);
                connection.on('data', function (data) {
                    console.log(data);
                    document.getElementById("demo").innerHTML = data;
                });
                setInterval(score_dispatch, 1000, connection);
                navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(
                    function (stream) {
                        console.log(document.getElementById("id-supply").value);
                        call = peer.call(document.getElementById("id-supply").value, stream);

                        call.on('stream', function (stream) {
                            video = document.getElementById('sendvidshere');
                            video.srcObject = stream;
                            video.autoplay = true;
                        });
                    }).catch(() => { });
            };
        </script>




</body>